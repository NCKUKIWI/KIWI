<input id="addcourseinput" type="text" placeholder="請輸入選課序號">
<table class="ui celled table unstackable" id="cart-table">
  <thead>
    <tr>
      <th class="">操作</th>
      <th class="">課程名稱</th>
      <th class="">時間</th>
    </tr>
  </thead>
  <tbody>
    <% if(user != undefined){ %>
      <% if(carts.length!=0){ %>
        <% for(var i in carts){ %>
          <tr class="course-row" id="course-<%= carts[i].id %>" data-id="<%= carts[i].id %>">
            <td>
              <i class="minus icon delcoursebtn" id="<%= carts[i].id %>" data-id="<%= carts[i].id %>">
              </i>
            </td>
            <td class="course_name" data-toggle="modal" data-target="#course-modal" data-id="<%= carts[i].id %>">
              <%= carts[i].課程名稱 %>
            </td>
            <td><%= carts[i].時間 %></td>
          </tr>
        <% } %>
      <% }else{ %>
        <td colspan="3" style="text-align:center;">無課程</td>
      <% } %>
    <% }else{ %>
      <td colspan="3" style="text-align:center;">無課程</td>
    <% } %>
  </tbody>
</table>

<div class="modal fade" id="course-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
    </div>
  </div>
</div>

<script>
$(document).ready(function() {

  /* 記錄用戶清單中的課程id */
  var carts = <%- JSON.stringify(carts) %>;

  /* Ajax show course */
  function ajaxshowcourse(id){
    var ajaxurl = '/course/'+ id;
    $.ajax({
      url:ajaxurl,
      type: 'GET',
      success: function(response) {
        $('#course-modal .modal-content').prepend(response);
        $('#course-modal').data('bs.modal').handleUpdate();
      }
    });
  }

  /* 綁定ajaxshowcourse function */
  $('.course-row .course_name').on('click',function(){
    var courseid= this.getAttribute("data-id");
    ajaxshowcourse(courseid);
  });

  /* modal 關閉時清空 modal 內容 */
  $('#course-modal').on('hidden.bs.modal', function () {
    $('#course-modal .modal-content').empty();
  });

  /* ajax del course */
  function delcourse(courseid){
    var ajaxurl = '/course/delcourse/'+ courseid;
    $.ajax({
      url:ajaxurl,
      type: 'POST',
      success: function(response){
        $('#course-'+courseid).fadeOut().remove();
        toastr.success('移除成功!');
      }
    });
  }

  /* 在減號上綁定移除課程的事件 */
  $('.delcoursebtn').on('click',function(){
    var courseid = this.getAttribute("data-id");
    delcourse(courseid);
  });

  // Got enter in add course input
  $("#addcourseinput").keyup(function (e) {
    if (e.keyCode == 13 ) {
      var course = $('#addcourseinput').val();
      $('#addcourseinput').val("");
      var ajaxurl = '/course/inputaddcourse/'+ course;
      $.ajax({
        url:ajaxurl,
        type: 'POST',
        success: function(response){
          /* 如果找不到課 */
          if(response=="Not found"){
            toastr.danger('找不到課程,請再次確認選課序號!');
          }
          else{
            /* 記錄清單中是否有找到一樣的課程 */
            var check = 0 ;
            /* 如果用戶有登入 */
            if(carts != null ){
              /* 檢查用戶清單中是否有這堂課 */
              for(var i in carts){
                /* 在清單中找到這堂課 */
                if(response[0].id==carts[i].id){
                  toastr.warning('已經有這堂課囉!');
                  check = 1;
                }
              }
              if(check==0){
                var dom = "<tr class='course-row' id='course-"+response[0].id+"' data-id='"+response[0].id+"'>                                                      <td><i class='minus icon delcoursebtn' data-id='"+response[0].id+"'></i></td>         <td class='course_name' data-toggle='modal' data-target='#course-modal'         data-id='"+response[0].id+"'>"+response[0].課程名稱+"</td>                                         <td>"+response[0].時間+"</td></tr>"
                $('#cart-table tbody').append(dom);
                toastr.success('選課成功!');
                /* 將新加入減號的綁定移除課程的事件 */
                $('.delcoursebtn').off().on('click',function(){
                  var courseid = this.getAttribute("data-id");
                  delcourse(courseid);
                });
                /* 將新加入的課程綁定 ajaxshowcourse function */
                $('.course-row .course_name').on('click',function(){
                  var courseid= this.getAttribute("data-id");
                  ajaxshowcourse(courseid);
                });
                /* 將新課程的ID加入用戶課程清單 */
                carts.push({'id':response[0].id});
              }
            }
            else{
              var dom = "<tr class='course-row' id='course-"+response[0].id+"' data-id='"+response[0].id+"'>                                                        <td><i class='minus icon removecourse' data-id='"+response[0].id+"'></i></td>                             <td class='course_name' data-toggle='modal' data-target='#course-modal'         data-id='"+ response[0].id+"'>"+response[0].課程名稱+"</td>                                           <td>"+response[0].時間+"</td></tr>"
              $('#cart-table tbody').append(dom);
              $('.removecourse').off().on('click',function(){
                var courseid = this.getAttribute("data-id");
                $('#course-'+courseid).fadeOut().remove();
                toastr.success('移除成功!');
              });
              /* 將新加入的課程綁定 ajaxshowcourse function */
              $('.course-row .course_name').on('click',function(){
                var courseid= this.getAttribute("data-id");
                ajaxshowcourse(courseid);
              });
              toastr.success('選課成功!');
            }
          }
        }
      });
    }
  });
});
</script>
